# План реализации интеграции amoCRM – Альта для статусов таможенных деклараций

Я изучил предоставленную задачу и проект. Проект avterminal-api на Laravel уже имеет интеграцию с amoCRM, включая:

1. **Генерация XML для пассажирской таможенной декларации (ПТД)** из карточки amoCRM
2. **API для приема статусов ДТ** (updateDtStatus) от внешних систем
3. **Перемещение в историю** предыдущих данных ДТ при изменении статуса
4. **Логирование** всех изменений

Для полной реализации интеграции согласно ТЗ нужны следующие действия:

## Что надо сделать в amoCRM

1. **Разделить поле ФИО клиента** на отдельные поля:
   - Добавить поля: "Фамилия", "Имя", "Отчество" в карточку контакта
   - Настроить поле "Фамилия" как автоматическую конкатенацию этих полей

2. **Добавить поле "Номер договора"** в карточку контакта для генерации XML ПТД

3. **Проверить поля адреса** - они уже разделены на поля адреса как указано в ТЗ

4. **Настроить дополнительные поля для транзитных ДТ** (аналогично существующим полям ДТ):
   - nomer_td (аналог nomer_dt)
   - status_td (аналог status_dt)
   - registration_date_td



## Конфиги для обновления

1. **Обновить config/amocrm.php**:
   - Добавить секцию полей для транзитных ДТ:
     ```php
     'td_fields' => [
         'nomer_td' => [
             'id' => NEW_FIELD_ID
         ],
         'status_td' => [
             'id' => NEW_FIELD_ID,
             'values' => [
                 // статусы для транзитных ДТ - уточнить из ТЗ
             ]
         ],
         // ... остальные поля аналогично dt
         'history_td' => [
             'id' => NEW_FIELD_ID
         ]
     ],
     ```
   - Добавить статусы для транзитных ДТ:
     ```php
     'td_statuses' => [
         'td/dt' => NEW_STATUS_ID,
         'vipusk_td' => NEW_STATUS_ID,
         'svh_td' => NEW_STATUS_ID
     ]
     ```

2. **Добавить переменные в .env** (если нужны новые токены или настройки)

## Промпт для ИИ агента реализации

```
Я хочу чтобы ты реализовал обновление статусов транзитных ДТ в Laravel приложении аналогично existing updateDtStatus для ПТД.

Структура проекта:
- Laravel 11 с сервисами в app/Services/AmoCRM/
- LeadService для изменения статусов сделок
- CustomFieldService для обновления полей с переносом в историю
- Конфигурация в config/amocrm.php

Задачи:
1. Создай новый метод updateTDtStatus в AmoCRMController аналогично updateDtStatus
2. Добавь маршрут POST /api/amocrm/t-dt-status
3. Обнови LeadService::updateLeadFromDtStatus для поддержки транзитных ДТ (или создай updateLeadFromTDtStatus)
4. Добавь в config/amocrm.php статусы и поля для транзитных ДТ:
   - регистрация ТД (возможно новые ID статусов)
   - выпуск ТД
   - отказ ТД
   - аннулирование ТД
   - другие статусы из ТЗ (уточнить какие именно статусы нужны для транзитных ДТ)
5. Создай тесты в AmoCRMControllerTest всех сценариев транзитных ДТ аналогично existing тестам ПТД
6. Добавь логирование в telescope и все операции с API amoCRM

Данные для передачи от Альты (входящий JSON):
{
  "vinNum": "VIN_NUMBER",
  "tdNum": "ТД_NUMBER",
  "status": "статус из конфигурации",
  "statusDate": "YYYY-MM-DD HH:mm"
}

При обработке:
- Использовать findLeadByVin для поиска сделки по VIN
- При изменении номера ТД переносить предыдущие данные в history_td
- Менять статус сделки согласно правилам
- Подсвечивать красным (color_field_id) для проблемных статусов
- Записывать все в логи telescope

Используй существующие методы CustomFieldService для работы с полями и историей.
```

## Мануал для разработчиков Альта

### Интеграция с API avterminal для обновления статусов таможенных деклараций

**Базовый URL:** `http://your-ip-address`

**Авторизация:** POST параметр `api_token` из контракта

#### 1. Обновление статуса пассажирской таможенной декларации (ПТД)

**Endpoint:** `POST /api/amocrm/dt-status`

**Headers:**
```
Content-Type: application/json
Authorization: Bearer {your_api_token}
```

**Body:**
```json
{
  "vinNum": "VIN_АВТОМОБИЛЯ",
  "pdNum": "НОМЕР_ПТД_ИЗ_АЛЬТА",
  "status": "СТАТУС_ИЗ_СПИСКА",
  "statusDate": "2025-01-15 10:30"
}
```

**Возможные статусы:**
- "регистрация ПТД"
- "выпуск без уплаты (10)"
- "выпуск с уплатой (32)"
- "требуется уплата (31)"
- "выпуск разрешен, ожидание решения по временному ввозу (33)"
- "отказ в разрешении (40)"
- "отказ в выпуске товаров (90)"
- "выпуск товаров аннулирован при отзыве ПТД (50)"

**Ответы:**
- `200`: `{"message": "OK"}` - успех
- `422`: валидация данных
- `500`: ошибка сервера

#### 2. Обновление статуса транзитной декларации (ТД)

**Endpoint:** `POST /api/amocrm/t-dt-status` (будет реализован после уточнения статусов)

**Формат аналогичный ПТД**, но с полем `tdNum` вместо `pdNum`

**Возможные статусы будут уточнены**, но аналогично ПТД:
- "регистрация ТД"
- "выпуск ТД"
- "отказ ТД"
- ...

### Примеры интеграции

#### PHP (Guzzle)
```php
$client = new Client();
$response = $client->post('http://api-url/api/amocrm/dt-status', [
    'headers' => [
        'Authorization' => 'Bearer ' . $apiToken,
        'Content-Type' => 'application/json'
    ],
    'json' => [
        'vinNum' => 'LVHTG6857N7007563',
        'pdNum' => '10511010/260525/5067807',
        'status' => 'регистрация ПТД',
        'statusDate' => '2025-01-15 10:30'
    ]
]);
```

#### Python (requests)
```python
import requests

headers = {
    'Authorization': f'Bearer {api_token}',
    'Content-Type': 'application/json'
}

data = {
    'vinNum': 'LVHTG6857N7007563',
    'pdNum' => '10511010/260525/5067807',
    'status' => 'регистрация ПТД',
    'statusDate' => '2025-01-15 10:30'
}

response = requests.post('http://api-url/api/amocrm/dt-status',
                        headers=headers, json=data)
```

### Важные замечания

1. **Все данные в записях на русском** и будут конвертированы в UPPERCASE для XML
2. **Даты** в формате YYYY-MM-DD HH:mm или DD.MM.YYYY HH:mm
3. **VIN** должен совпадать с VIN в карточке amoCRM для поиска сделки
4. **При изменении номера декларации** предыдущие данные переносятся в историю
5. **Проблемные статусы** подсвечивают сделку красным цветом в amoCRM
6. **Все действия логируются** в telescope для отладки
7. **Тестовый режим** доступен для проверки без реальных изменений в amoCRM

### Последовательность работ

1. **Уточнить статусы транзитных ДТ** с бизнес-аналитиками
2. **Настроить поля и статусы в amoCRM**
3. **Обновить конфигурацию Laravel**
4. **Реализовать API endpoint для ТД**
5. **Протестировать интеграцию**
6. **Предоставить мануал и доступ к тестам Альту**

Если нужны дополнительные поля или уточнение форматов - сообщите.