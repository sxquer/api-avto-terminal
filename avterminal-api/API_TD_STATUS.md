# API для обновления статусов транзитных ДТ

## Обзор

Этот документ описывает API endpoint для обновления статусов транзитных декларации (ТД) в системе AmoCRM.

## Endpoint

```
POST /api/amocrm/td-status
```

## Аутентификация

Требуется Bearer токен (Sanctum).

```
Authorization: Bearer {your-token}
```

## Формат запроса

### Headers
```
Content-Type: application/json
Authorization: Bearer {token}
```

### Body (JSON)

```json
{
  "vinNum": "LSGXC8356MV107322",
  "tdNum": "10716050/151025/0А050168",
  "status": "ТД Зарегистрирована",
  "statusDate": "2025-10-15 16:27:11"
}
```

### Параметры

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `vinNum` | string | Да | VIN номер автомобиля для поиска сделки |
| `tdNum` | string | Да | Номер транзитной декларации |
| `status` | string | Да | Статус ТД (регистронезависимо: "ТД Зарегистрирована") |
| `statusDate` | string | Да | Дата статуса в формате "dd.mm.yyyy hh:mm" или "yyyy-mm-dd hh:mm:ss" |

## Поддерживаемые форматы даты

API поддерживает следующие форматы даты:

1. **dd.mm.yyyy hh:mm** - `"15.10.2025 16:27"`
2. **dd.mm.yyyy hh.mm** - `"15.10.2025 16.27"` (точка вместо двоеточия)
3. **yyyy-mm-dd hh:mm:ss** - `"2025-10-15 16:27:11"`

### Коррекция часового пояса

Все даты корректируются на -10 часов (UTC+10 → UTC) для соответствия внутреннему представлению AmoCRM.

**Пример:**
- Входящая дата: `"15.10.2025 16:00"` (UTC+10)
- Фактическое время: `"15.10.2025 06:00"` (UTC, после коррекции -10 часов)

## Статусы

### Поддерживаемые статусы

На данный момент поддерживается **только один статус** (регистронезависимо):

- ✅ `"ТД Зарегистрирована"`
- ✅ `"тд зарегистрирована"`
- ✅ `"Тд ЗаРеГиСтРиРоВаНа"`

Все варианты регистра обрабатываются корректно.

## Бизнес-логика

### Обновление полей в AmoCRM

При получении статуса "ТД Зарегистрирована" обновляются следующие поля:

1. **nomer_td** (ID: 984681) - Номер транзитной декларации
2. **status_td** (ID: 984685) - Статус ТД (из конфигурации)
3. **registration_date_td** (ID: 984687) - Дата регистрации ТД (timestamp)

### Изменение статуса сделки

Статус сделки изменяется на **"Транзит"** (`td_transit_status`, ID: 83281430) **только если**:

- Текущий статус сделки находится в списке `td_statuses_to_change`:
  - 62360714
  - 62360726
  - 62360954

Если сделка находится в другом статусе, поля обновляются, но **статус сделки НЕ меняется**.

### Особенности

- ❌ **Нет переноса в историю** (в отличие от ПТД)
- ❌ **Нет проверки смены номера ТД**
- ❌ **Нет подсветки красным**
- ✅ **Простая логика**: обновить поля + изменить статус (если применимо)

## Примеры запросов

### Пример 1: Успешный запрос (статус меняется)

**Request:**
```bash
curl -X POST https://your-domain.com/api/amocrm/td-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token-here" \
  -d '{
    "vinNum": "LSGXC8356MV107322",
    "tdNum": "10716050/151025/0А050168",
    "status": "ТД Зарегистрирована",
    "statusDate": "15.10.2025 16:27"
  }'
```

**Response (200 OK):**
```json
{
  "message": "OK"
}
```

**Что произошло:**
- Найдена сделка с VIN: `LSGXC8356MV107322`
- Текущий статус сделки был в списке `td_statuses_to_change`
- Обновлены поля: `nomer_td`, `status_td`, `registration_date_td`
- Статус сделки изменен на `td_transit_status` (Транзит)

### Пример 2: Успешный запрос (статус НЕ меняется)

**Request:**
```bash
curl -X POST https://your-domain.com/api/amocrm/td-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token-here" \
  -d '{
    "vinNum": "WBAAA1234567890",
    "tdNum": "20716050/201025/0B123456",
    "status": "тд зарегистрирована",
    "statusDate": "2025-10-20 14:30:00"
  }'
```

**Response (200 OK):**
```json
{
  "message": "OK"
}
```

**Что произошло:**
- Найдена сделка с VIN: `WBAAA1234567890`
- Текущий статус сделки **НЕ был** в списке `td_statuses_to_change`
- Обновлены поля: `nomer_td`, `status_td`, `registration_date_td`
- Статус сделки **НЕ изменен** (остался прежним)

### Пример 3: Формат даты с точкой

**Request:**
```json
{
  "vinNum": "JN1ABCD1234567890",
  "tdNum": "30716050/301025/0C987654",
  "status": "Тд ЗаРеГиСтРиРоВаНа",
  "statusDate": "30.10.2025 18.45"
}
```

**Response (200 OK):**
```json
{
  "message": "OK"
}
```

## Обработка ошибок

### Ошибка 422: Валидация

**Request с отсутствующим полем:**
```json
{
  "vinNum": "LSGXC8356MV107322",
  "status": "ТД Зарегистрирована"
}
```

**Response (422 Unprocessable Entity):**
```json
{
  "error": "Validation failed",
  "details": {
    "tdNum": ["The td num field is required."],
    "statusDate": ["The status date field is required."]
  }
}
```

### Ошибка 500: VIN не найден

**Request с несуществующим VIN:**
```json
{
  "vinNum": "NONEXISTENT123456",
  "tdNum": "10716050/151025/0А050168",
  "status": "ТД Зарегистрирована",
  "statusDate": "15.10.2025 16:27"
}
```

**Response (500 Internal Server Error):**
```json
{
  "error": "Сделка с VIN NONEXISTENT123456 не найдена"
}
```

### Ошибка 500: Неподдерживаемый статус

**Request с неверным статусом:**
```json
{
  "vinNum": "LSGXC8356MV107322",
  "tdNum": "10716050/151025/0А050168",
  "status": "Неизвестный статус",
  "statusDate": "15.10.2025 16:27"
}
```

**Response (500 Internal Server Error):**
```json
{
  "error": "Статус 'Неизвестный статус' не поддерживается. Ожидается: 'ТД Зарегистрирована'"
}
```

### Ошибка 500: Статус ТД не найден в конфигурации

**Response (500 Internal Server Error):**
```json
{
  "error": "Статус ТД не найден в конфигурации"
}
```

## Логирование

Все операции логируются в **Laravel Telescope** со следующими событиями:

### 1. Начало обработки
```php
Log::info("TD status update: начало обработки", [
    'lead_id' => 25147637,
    'vin' => 'LSGXC8356MV107322',
    'td_num' => '10716050/151025/0А050168',
    'status' => 'ТД Зарегистрирована',
    'status_date' => '15.10.2025 16:27',
    'current_stage_id' => 62360714,
    'should_change_status' => true
]);
```

### 2. Поля обновлены
```php
Log::info("TD status update: поля обновлены", [
    'lead_id' => 25147637,
    'fields_updated' => ['nomer_td', 'status_td', 'registration_date_td']
]);
```

### 3. Статус изменен (если применимо)
```php
Log::info("TD status update: статус сделки изменен", [
    'lead_id' => 25147637,
    'old_status_id' => 62360714,
    'new_status_id' => 83281430
]);
```

### 4. Статус НЕ изменен
```php
Log::info("TD status update: статус сделки НЕ изменен (не в списке td_statuses_to_change)", [
    'lead_id' => 25147637,
    'current_status_id' => 81192786
]);
```

## Конфигурация

Настройки находятся в `config/amocrm.php`:

```php
'fields' => [
    'nomer_td' => [
        'id' => 984681,
    ],
    'status_td' => [
        'id' => 984685,
        'values' => [
            "ТД Зарегистрирована" => 1238357,
        ],
    ],
    'registration_date_td' => [
        'id' => 984687
    ],
],

// Статусы из которых при получении ТД переходим в статус Транзит
'td_statuses_to_change' => [
    62360714,
    62360726,
    62360954
],

// Целевой статус "Транзит"
'td_transit_status' => 83281430,
```

## Тестовый режим

Для тестирования без изменения реальных сделок, установите в `.env`:

```env
AMOCRM_TEST_MODE=true
```

В тестовом режиме всегда используется сделка с ID: **25147637**

## Сравнение с DT Status API

| Функция | DT Status | TD Status |
|---------|-----------|-----------|
| Множественные статусы | ✅ (8 статусов) | ❌ (1 статус) |
| Перенос в историю | ✅ | ❌ |
| Проверка смены номера | ✅ | ❌ |
| Подсветка красным | ✅ | ❌ |
| Условное изменение статуса | ✅ (защищенные стадии) | ✅ (список td_statuses_to_change) |
| Поддержка форматов даты | ✅ (3 формата) | ✅ (3 формата) |
| Коррекция UTC+10 | ✅ | ✅ |
| Логирование Telescope | ✅ | ✅ |

## Интеграция с Альтой

Альта должна отправлять webhook на этот endpoint при регистрации транзитной декларации.

### Формат данных от Альты

```json
{
  "vinNum": "VIN_NUMBER",
  "tdNum": "ТД_NUMBER",
  "status": "ТД Зарегистрирована",
  "statusDate": "YYYY-MM-DD HH:mm"
}
```

## Безопасность

1. ✅ Валидация всех входящих данных
2. ✅ Аутентификация через Sanctum
3. ✅ Проверка существования VIN
4. ✅ Проверка статуса (регистронезависимо)
5. ✅ Обработка всех исключений
6. ✅ Детальное логирование в Telescope

## Дополнительные ресурсы

- [API для ПТД/ДТ статусов](./API_DT_STATUS.md)
- [Руководство по тестированию](./TESTING_DT_STATUS.md)
- [Документация AmoCRM сервисов](./app/Services/AmoCRM/README.md)

---

**Версия:** 1.0  
**Дата:** 08.02.2026  
**Автор:** Cline AI Assistant