# API метод обновления статуса ДТ

## Описание
Метод для обновления статуса декларации на товары (ДТ) в сделке AmoCRM.

## Эндпоинт
```
POST /api/amocrm/dt-status
```

## Аутентификация
Требуется Bearer токен (Sanctum).

```
Authorization: Bearer {your-token}
```

## Формат запроса

### Headers
```
Content-Type: application/json
Authorization: Bearer {token}
```

### Body (JSON)
```json
{
  "vinNum": "LSGXC8356MV107322",
  "pdNum": "10716050/151025/А050168",
  "status": "Регистрация ПТД",
  "statusDate": "15.10.2025 16:27"
}
```

### Параметры

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| vinNum | string | Да | VIN номер автомобиля |
| pdNum | string | Да | Номер декларации на товары (ДТ) |
| status | string | Да | Текстовый статус (без цифр в скобках) |
| statusDate | string | Да | Дата статуса в формате "dd.mm.yyyy hh:mm" |

### Поддерживаемые статусы

- `регистрация ПТД`
- `выпуск без уплаты`
- `требуется уплата`
- `выпуск с уплатой`
- `выпуск разрешен, ожидание решения по временному ввозу`
- `отказ в разрешении`
- `выпуск товаров аннулирован при отзыве ПТД`
- `отказ в выпуске товаров`

## Формат ответа

### Успешный ответ (200 OK)
```json
{
  "message": "OK"
}
```

### Ошибка валидации (422 Unprocessable Entity)
```json
{
  "error": "Validation failed",
  "details": {
    "vinNum": ["The vinNum field is required."]
  }
}
```

### Ошибка обработки (500 Internal Server Error)
```json
{
  "error": "Сделка с VIN XXXXX не найдена"
}
```

или

```json
{
  "error": "Статус 'неизвестный статус' не найден в конфигурации"
}
```

## Логика работы

### 1. Поиск сделки
- В тестовом режиме (`AMOCRM_TEST_MODE=true`): всегда использует сделку с ID `25147637`
- В обычном режиме: ищет сделку по VIN номеру

### 2. Проверка номера ДТ (Правило 2.4.0)
Если входящий номер ДТ отличается от текущего в карточке:
- Текущие данные ДТ переносятся в поле "История"
- Все поля ДТ обнуляются перед записью новых значений

### 3. Обновление полей в зависимости от статуса

#### Регистрация ПТД (Правило 2.4.1)
- Заполняется: `Дата регистрации ДТ`
- Стадия: `ПТД/ДТ`

#### Выпуск без уплаты / Выпуск с уплатой (Правило 2.4.2)
- Заполняется: `Дата выпуска ДТ`
- Стадия: `Выпуск ПТД/ДТ`

#### Отказы (Правило 2.4.3)
Статусы:
- `отказ в выпуске товаров`
- `выпуск товаров аннулирован при отзыве ПТД`
- `отказ в разрешении`

Действия:
- Заполняется: `Дата отказа ДТ`
- Стадия: `ПТД/ДТ`
- **Подсвечивается красным** (поле `color_field_id` = "Красный")

#### Ожидание (Правило 2.4.4)
Статусы:
- `требуется уплата`
- `выпуск разрешен, ожидание решения по временному ввозу`

Действия:
- Стадия: `ПТД/ДТ`
- **Подсвечивается красным** (поле `color_field_id` = "Красный")

## Примеры использования

### Пример 1: Регистрация ПТД
```bash
curl -X POST https://your-domain.com/api/amocrm/dt-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "vinNum": "LB378JNZ2SH031264",
    "pdNum": "10716050/291025/А055619",
    "status": "регистрация ПТД",
    "statusDate": "04.11.2025 19:50"
  }'
```

### Пример 2: Выпуск с уплатой
```bash
curl -X POST https://your-domain.com/api/amocrm/dt-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "vinNum": "LB378JNZ2SH031264",
    "pdNum": "10716050/291025/А055619",
    "status": "выпуск с уплатой",
    "statusDate": "05.11.2025 14:30"
  }'
```

### Пример 3: Отказ в выпуске
```bash
curl -X POST https://your-domain.com/api/amocrm/dt-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "vinNum": "LB378JNZ2SH031264",
    "pdNum": "10716050/291025/А055619",
    "status": "отказ в выпуске товаров",
    "statusDate": "05.11.2025 16:00"
  }'
```

## Настройка тестового режима

В файле `.env` добавьте:

```env
# Тестовый режим - всегда использует сделку с ID 25147637
AMOCRM_TEST_MODE=true
```

Или для production:
```env
AMOCRM_TEST_MODE=false
```

## Обновляемые поля в AmoCRM

### Всегда обновляются:
- `Номер ДТ` (nomer_dt)
- `Статус ДТ` (status_dt)

### В зависимости от статуса:
- `Дата регистрации ДТ` (registration_date)
- `Дата выпуска ДТ` (vipusk_date)
- `Дата отказа ДТ` (refuse_date)
- `Цвет` (color_field_id) - для статусов с подсветкой

### При смене номера ДТ:
- `История` (history) - сохраняет предыдущие данные

## Формат истории

При переносе в историю создается запись вида:
```
# Декларация: 10716050/151025/А050168
# Статус ДТ: выпуск с уплатой (32)
# Дата регистрации ДТ: 15.10.2025
# Дата выпуска ДТ: 04.11.2025
# Дата отказа ДТ: -
```

## Технические детали

### Поиск статуса
Метод использует поиск по подстроке, игнорируя цифры в скобках:
- Входящий статус: `"выпуск с уплатой"`
- Конфиг: `"выпуск с уплатой (32)" => 1234085`
- Результат: находит соответствие

### Формат даты
Поддерживаются форматы:
- `dd.mm.yyyy hh:mm` (например: "04.11.2025 19:50")
- `dd.mm.yyyy hh.mm` (с точкой вместо двоеточия)

### Изменение стадии сделки
ID стадий из конфига:
- `ПТД/ДТ`: 62360974
- `Выпуск ПТД/ДТ`: 81192786

## Коды ошибок

| Код | Описание |
|-----|----------|
| 200 | Успешное обновление |
| 422 | Ошибка валидации входных данных |
| 500 | Внутренняя ошибка (сделка не найдена, статус не найден и т.д.) |
