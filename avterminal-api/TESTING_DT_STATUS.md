# Тестирование API обновления статуса ДТ

## Обзор

Данный документ описывает систему тестирования для API-метода обновления статуса декларации на товары (ДТ).

## Основной API-метод

**Endpoint:** `POST /api/amocrm/dt-status`

**Требуется авторизация:** Bearer Token

**Формат запроса:**
```json
{
  "vinNum": "LB378JNZ2SH031264",
  "pdNum": "10716050/291025/А055619",
  "status": "выпуск с уплатой",
  "statusDate": "04.11.2025 19:50"
}
```

**Пример успешного ответа:**
```json
{
  "message": "OK"
}
```

## Тестовая система

Для удобства тестирования создана система автоматических тестов, которые можно запускать без необходимости создавать JSON запросы вручную.

### Получение списка всех тестов

```bash
curl http://localhost:8000/api/test/list
```

Возвращает список из 10 предопределенных тестов с описанием каждого.

### Запуск конкретного теста

```bash
curl http://localhost:8000/api/test/{номер_теста}
```

Где `{номер_теста}` - число от 1 до 10.

**Пример:**
```bash
curl http://localhost:8000/api/test/3
```

## Описание тестов

### Тест #1: Регистрация ПТД
**Статус:** `регистрация ПТД`

**Ожидаемое поведение:**
- Заполняется поле "Дата регистрации ДТ"
- Сделка перемещается на стадию "ПТД/ДТ"
- Карточка не подсвечивается красным

### Тест #2: Выпуск без уплаты
**Статус:** `выпуск без уплаты` (или с кодом `10`)

**Ожидаемое поведение:**
- Заполняется поле "Дата выпуска ДТ"
- Сделка перемещается на стадию "Выпуск ПТД/ДТ"
- Карточка не подсвечивается красным

### Тест #3: Выпуск с уплатой
**Статус:** `выпуск с уплатой` (или с кодом `32`)

**Ожидаемое поведение:**
- Заполняется поле "Дата выпуска ДТ"
- Сделка перемещается на стадию "Выпуск ПТД/ДТ"
- Карточка не подсвечивается красным

### Тест #4: Требуется уплата (ожидание)
**Статус:** `требуется уплата` (или с кодом `31`)

**Ожидаемое поведение:**
- Сделка остается на стадии "ПТД/ДТ"
- Карточка подсвечивается красным цветом
- Статус ДТ обновляется

### Тест #5: Ожидание решения по временному ввозу
**Статус:** `выпуск разрешен, ожидание решения по временному ввозу` (или с кодом `33`)

**Ожидаемое поведение:**
- Сделка остается на стадии "ПТД/ДТ"
- Карточка подсвечивается красным цветом
- Статус ДТ обновляется

### Тест #6: Отказ в выпуске товаров
**Статус:** `отказ в выпуске товаров` (или с кодом `90`)

**Ожидаемое поведение:**
- Заполняется поле "Дата отказа ДТ"
- Сделка перемещается на стадию "ПТД/ДТ"
- Карточка подсвечивается красным цветом

### Тест #7: Отказ в разрешении
**Статус:** `отказ в разрешении` (или с кодом `40`)

**Ожидаемое поведение:**
- Заполняется поле "Дата отказа ДТ"
- Сделка перемещается на стадию "ПТД/ДТ"
- Карточка подсвечивается красным цветом

### Тест #8: Выпуск аннулирован при отзыве ПТД
**Статус:** `выпуск товаров аннулирован при отзыве ПТД` (или с кодом `50`)

**Ожидаемое поведение:**
- Заполняется поле "Дата отказа ДТ"
- Сделка перемещается на стадию "ПТД/ДТ"
- Карточка подсвечивается красным цветом

### Тест #9: Формат даты с точкой вместо двоеточия
**Статус:** `регистрация ПТД`
**Дата:** `05.11.2025 18.30` (точка вместо двоеточия в времени)

**Ожидаемое поведение:**
- Дата корректно парсится несмотря на альтернативный формат
- Все остальные действия как в тесте #1

### Тест #10: Несуществующий статус (проверка ошибки)
**Статус:** `несуществующий статус`

**Ожидаемое поведение:**
- Возвращается ошибка 500
- Сообщение об ошибке: "Статус 'несуществующий статус' не найден в конфигурации"

## Тестовый режим

В тестовом режиме (`test_mode = true` в конфиге) метод поиска сделки по VIN всегда возвращает ID `25147637`.

Для включения тестового режима установите в файле `.env`:
```
AMOCRM_TEST_MODE=true
```

Или в `config/amocrm.php`:
```php
'test_mode' => env('AMOCRM_TEST_MODE', false),
```

## Пример полного тестирования

### 1. Запустить список тестов
```bash
curl http://localhost:8000/api/test/list
```

### 2. Запустить тест "Выпуск с уплатой"
```bash
curl http://localhost:8000/api/test/3
```

### 3. Запустить тест с ошибкой
```bash
curl http://localhost:8000/api/test/10
```

### 4. Ручной запрос к основному API
```bash
curl -X POST http://localhost:8000/api/amocrm/dt-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "vinNum": "LB378JNZ2SH031264",
    "pdNum": "10716050/291025/А055619",
    "status": "выпуск с уплатой",
    "statusDate": "04.11.2025 19:50"
  }'
```

## Формат ответа тестов

### Успешный тест
```json
{
  "test_number": "3",
  "test_name": "Выпуск с уплатой",
  "description": "...",
  "request_data": {...},
  "expected_result": {...},
  "actual_result": {
    "lead_id": 25147637,
    "status": "OK",
    "stage": "vipusk",
    "highlight_red": false,
    "moved_to_history": true
  },
  "status": "SUCCESS",
  "message": "Тест выполнен успешно"
}
```

### Тест с ошибкой (ожидаемая ошибка)
```json
{
  "test_number": "10",
  "test_name": "Несуществующий статус (проверка ошибки)",
  "description": "...",
  "request_data": {...},
  "expected_result": {...},
  "status": "FAILED",
  "error": "Статус 'несуществующий статус' не найден в конфигурации"
}
```

## Конфигурация статусов

Статусы настраиваются в файле `config/amocrm.php`:

```php
'status_dt' => [
    'id' => 979425,
    'values' => [
        "регистрация ПТД" => 1234079,
        "выпуск без уплаты (10)" => 1234081,
        "требуется уплата (31)" => 1234083,
        "выпуск с уплатой (32)" => 1234085,
        "выпуск разрешен, ожидание решения по временному ввозу (33)" => 1234087,
        "отказ в разрешении (40)" => 1234089,
        "выпуск товаров аннулирован при отзыве ПТД (50)" => 1234091,
        "отказ в выпуске товаров (90)" => 1234093
    ],
],
```

## Важные замечания

1. **Поиск статуса по подстроке**: В конфигурации статусы могут содержать код в скобках (например, `выпуск с уплатой (32)`), но во входящих данных код может отсутствовать. Система ищет статус по подстроке, поэтому `выпуск с уплатой` найдет `выпуск с уплатой (32)`.

2. **Регистр не имеет значения**: Поиск статусов выполняется без учета регистра.

3. **Сохранение в историю**: Если номер ДТ изменился, старые данные автоматически сохраняются в поле истории перед обновлением.

4. **Форматы дат**: Поддерживаются форматы дат:
   - `DD.MM.YYYY HH:MM`
   - `DD.MM.YYYY HH.MM` (точка вместо двоеточия)

## Отладка

Для просмотра логов Laravel:
```bash
tail -f storage/logs/laravel.log
```

Для очистки кеша маршрутов:
```bash
php artisan route:clear && php artisan route:cache
